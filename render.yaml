services:
  - type: web
    name: predicta-api
    env: python
    plan: free

    buildCommand: |
      echo "üì¶ Installing dependencies..."
      pip install --upgrade pip
      pip install -r requirements.txt
      pip install gdown

      echo "üì• Downloading weighted model from Google Drive..."
      mkdir -p models
      FILE_ID="1nrza381tsPprpML7mAafd6DNU93y5BT7"
      gdown --id "$FILE_ID" -O models/weighted_model.pkl --fuzzy

      # Boyut kontrol√º (Linux & Mac uyumlu)
      if [ -f models/weighted_model.pkl ]; then
        FILE_SIZE=$(stat -c%s models/weighted_model.pkl 2>/dev/null || stat -f%z models/weighted_model.pkl)
        SIZE_MB=$((FILE_SIZE / 1024 / 1024))
        echo "‚úÖ Model downloaded successfully: ${SIZE_MB} MB"
      else
        echo "‚ùå ERROR: Model file not found after download!"
        exit 1
      fi

      # Web klas√∂r√ºne ta≈üƒ±
      mkdir -p web/models
      cp models/weighted_model.pkl web/models/

      echo "üéâ Build completed successfully!"

    startCommand: uvicorn web.main_weighted:app --host 0.0.0.0 --port $PORT

    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: TZ
        value: Europe/Istanbul
